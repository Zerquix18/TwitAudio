function init(e){sampleRate=e.sampleRate,mp3Encoder=new MP3Encoder({mp3LibPath:e.mp3LibPath}),recordAsMP3=e.recordAsMP3||!1,recordAsOGG=!1,recordAsMP3&&mp3Encoder.init(mp3defaultConfig),recordAsOGG&&(vorbisEncoder.init(vorbisdefaultConfig),vorbisEncoder.writeHeaders())}function record(e){if(recBuffersL.push(e[0]),recLength+=e[0].length,recordAsMP3){var r=mp3Encoder.encode(e[0]);r.length>0&&recBufferMP3.push(r)}recordAsOGG&&(vorbisEncoder.encode([e[0]]),vorbisEncoder.flush())}function exportWAV(e){var r=mergeBuffers(recBuffersL,recLength),t=encodeWAV(r),n=new Blob([t],{type:e});this.postMessage(n)}function exportMP3(){var e;if(recordAsMP3)e=mp3Encoder.getMP3();else{var r=mergeBuffers(recBuffersL,recLength);e=mp3Encoder.toFile(r,mp3defaultConfig)}this.postMessage(e)}function exportOGG(){var e;if(recordAsOGG)e=vorbisEncoder.getOGG();else{var r=mergeBuffers(recBuffersL,recLength);e=vorbisEncoder.toFile([r],vorbisdefaultConfig)}this.postMessage(e)}function getBuffer(){var e=[];e.push(mergeBuffers(recBuffersL,recLength)),e.push(mergeBuffers(recBuffersR,recLength)),this.postMessage(e)}function clear(){recLength=0,recBuffersL=[],recBuffersR=[],recBufferMP3=[]}function mergeBuffers(e,r){for(var t=new Float32Array(r),n=0,o=0;o<e.length;o++)t.set(e[o],n),n+=e[o].length;return t}function interleave(e,r){for(var t=e.length+r.length,n=new Float32Array(t),o=0,i=0;t>o;)n[o++]=e[i],n[o++]=r[i],i++;return n}function floatTo16BitPCM(e,r,t){for(var n=0;n<t.length;n++,r+=2){var o=Math.max(-1,Math.min(1,t[n]));e.setInt16(r,0>o?32768*o:32767*o,!0)}}function writeString(e,r,t){for(var n=0;n<t.length;n++)e.setUint8(r+n,t.charCodeAt(n))}function encodeWAV(e){var r=new ArrayBuffer(44+2*e.length),t=new DataView(r);return writeString(t,0,"RIFF"),t.setUint32(4,32+2*e.length,!0),writeString(t,8,"WAVE"),writeString(t,12,"fmt "),t.setUint32(16,16,!0),t.setUint16(20,1,!0),t.setUint16(22,1,!0),t.setUint32(24,sampleRate,!0),t.setUint32(28,2*sampleRate,!0),t.setUint16(32,2,!0),t.setUint16(34,16,!0),writeString(t,36,"data"),t.setUint32(40,2*e.length,!0),floatTo16BitPCM(t,44,e),t}var recLength=0,recBuffersL=[],recBuffersR=[],bits=16,sampleRate,recordAsMP3=!1,recordAsOGG=!1,recBufferMP3=[],mp3Encoder,vorbisEncoder,mp3defaultConfig={mode:3,channels:1};vorbisdefaultConfig={channels:1,quality:1,sampleRate:sampleRate},this.onmessage=function(e){switch(e.data.command){case"init":init(e.data.config);break;case"record":record(e.data.buffer);break;case"exportWAV":exportWAV(e.data.type);break;case"getBuffer":getBuffer();break;case"exportMP3":exportMP3();break;case"exportOGG":exportOGG();break;case"clear":clear()}};var MP3Encoder=function(e){function r(e){f=new u.Mp3Encoder(e.cannels||1,e.sampleRate||44100,e.bitRate||64)}function t(e){var r=n(e),t=f.encodeBuffer(r);return t}function n(e){function r(e){var r=0>e?32768*e:32767*e;return Math.max(-32768,Math.min(32768,r))}for(var t=e.length,n=0,o=new Int16Array(t);t>n;)o[n]=r(e[n++]);return o}function o(){return f.flush()}function i(){return f.flush()}function a(e,n){r(n);var i=[t(e)];i.push(o());var a=new Blob(i,{type:"audio/mp3"});return a}function s(){var e=new Blob(recBufferMP3,{type:"audio/mp3"});return e}e=e||{};var c=e.mp3LibPath||"lame.all.js";importScripts(c);var f,u=new lamejs;this.init=r,this.encode=t,this.toFile=a,this.getMP3=s,this.flush=i},VorbisEncoder=function(e){function r(e){t(),l=[],f=Module.lib.encoder_create_vbr(e.channels||1,e.sampleRate||44100,e.quality||.7)}function t(){var e=Module.lib.helpers.get_data(f);return 0===e.length?null:(Module.lib.encoder_clear_data(f),void l.push(e))}function n(){Module.lib.encoder_write_headers(f)}function o(e){e=e.map(function(e){return e.buffer}),e=e.map(function(e){return new Float32Array(e)});var r=e[0].length;Module.lib.helpers.encode(f,r,e)}function i(){Module.lib.encoder_finish(f),Module.lib.encoder_destroy(f)}function a(){return new Blob(l,{type:"audio/ogg"})}function s(){return i(),t(),a()}function c(e,s){return r(s),n(),o(e),i(),t(),a()}var f=null,u=e.vorbisLibPath||"libvorbis.module.min.js";importScripts(u);var l=[];this.init=r,this.writeHeaders=n,this.toFile=c,this.flush=t,this.encode=o,this.getOGG=s};